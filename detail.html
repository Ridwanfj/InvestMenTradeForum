<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Properti - TEGAL INVESTMENT & TRADE FORUM 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .info-row:hover { background-color: #f0f9ff; }
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 50%, #e5e7eb 75%); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-blue-800 flex items-center"><img src="Asset 1.png" alt="Logo" class="h-16 mr-2">TEGAL INVESTMENT & TRADE FORUM 2026</a>
            <!-- Hamburger Button -->
            <button id="menu-toggle" class="md:hidden text-gray-700 focus:outline-none">
                <i class="fas fa-bars text-2xl"></i>
            </button>
            <nav class="hidden md:flex space-x-6 font-medium">
                <a href="index.html" class="hover:text-blue-600 transition">Beranda</a>
                <a href="#" class="hover:text-blue-600 transition">Tentang Kami</a>
                <a href="contact.html" class="hover:text-blue-600 transition">Kontak</a>
            </nav>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t">
            <nav class="container mx-auto px-6 py-4 flex flex-col space-y-3 font-medium">
                <a href="index.html" class="hover:text-blue-600 transition">Beranda</a>
                <a href="#" class="hover:text-blue-600 transition">Tentang Kami</a>
                <a href="contact.html" class="hover:text-blue-600 transition">Kontak</a>
            </nav>
        </div>
    </header>

    <section class="bg-blue-900 text-white py-10">
        <div class="container mx-auto px-6">
            <a href="index.html" class="inline-flex items-center text-blue-200 hover:text-white mb-4 transition">
                <i class="fas fa-arrow-left mr-2"></i> Kembali
            </a>
            <h2 class="text-3xl md:text-4xl font-bold">Detail Properti</h2>
            <p class="text-blue-100 mt-2" id="header-subtitle">Memuat data...</p>
        </div>
    </section>

    <!-- Loading State -->
    <div id="loading-state" class="container mx-auto px-6 py-12">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            <div class="space-y-4">
                <div class="skeleton rounded-xl h-96 w-full"></div>
                <div class="skeleton rounded-xl h-64 w-full"></div>
            </div>
            <div class="skeleton rounded-xl h-full min-h-96"></div>
        </div>
    </div>

    <!-- Content (hidden until loaded) -->
    <main id="content" class="container mx-auto px-6 py-12 hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
            
            <!-- Foto Properti -->
            <div class="space-y-4">
                <div class="rounded-xl overflow-hidden shadow-lg relative bg-gray-200 h-80 md:h-96">
                    <img id="foto-properti" src="" alt="Foto Properti" class="w-full h-full object-cover">
                    <div id="foto-fallback" class="w-full h-full bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center absolute inset-0 top-0 left-0" style="display:none;">
                        <div class="text-center text-white p-6">
                            <i class="fas fa-image text-6xl mb-4 opacity-70"></i>
                            <p class="text-lg opacity-80">Foto tidak tersedia</p>
                        </div>
                    </div>
                </div>
                
                <!-- Peta Lokasi -->
                <div class="bg-white rounded-xl shadow-lg p-4">
                    <h3 class="font-bold text-lg mb-3 text-blue-800">
                        <i class="fas fa-map-marker-alt mr-2"></i>Lokasi di Peta
                    </h3>
                    <div class="rounded-lg overflow-hidden">
                        <iframe id="peta-lokasi" src="" width="100%" height="250" style="border:0;" allowfullscreen="" loading="lazy"></iframe>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">
                        <i class="fas fa-crosshairs mr-1"></i>Koordinat: <span id="koordinat-text"></span>
                    </p>
                </div>
            </div>

            <!-- Detail Informasi -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-blue-800 text-white p-6">
                    <h3 class="text-2xl font-bold" id="nama-properti">-</h3>
                    <span class="inline-block bg-blue-600 px-3 py-1 rounded-full text-sm mt-2">
                        <i class="fas fa-building mr-1"></i>Properti
                    </span>
                </div>
                
                <div class="divide-y divide-gray-100" id="info-container">
                    <!-- Data akan diisi oleh JavaScript -->
                </div>

                <!-- Action Buttons -->
                <div class="p-6 bg-gray-50 flex flex-wrap gap-3">
                    <a id="btn-call" href="#" class="flex-1 min-w-fit bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition text-center">
                        <i class="fas fa-phone mr-2"></i>Hubungi
                    </a>
                    <a id="btn-wa" href="#" target="_blank" class="flex-1 min-w-fit bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition text-center">
                        <i class="fab fa-whatsapp mr-2"></i>WhatsApp
                    </a>
                    <a id="btn-maps" href="#" target="_blank" class="flex-1 min-w-fit bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 transition text-center">
                        <i class="fas fa-directions mr-2"></i>Rute
                    </a>
                </div>
            </div>
        </div>
    </main>

    <!-- Error State -->
    <div id="error-state" class="container mx-auto px-6 py-12 hidden">
        <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
            <i class="fas fa-exclamation-triangle text-red-500 text-5xl mb-4"></i>
            <h3 class="text-xl font-bold text-red-700 mb-2">Gagal Memuat Data</h3>
            <p class="text-red-600 mb-4" id="error-message">Terjadi kesalahan saat mengambil data dari spreadsheet.</p>
            <button onclick="fetchData()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition">
                <i class="fas fa-redo mr-2"></i>Coba Lagi
            </button>
        </div>
    </div>

    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; 2026 TEGAL INVESTMENT & TRADE FORUM. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // Hamburger Menu Toggle
        document.getElementById('menu-toggle').addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        });
    </script>

    <script>
        // API endpoint (Vercel Serverless Function)
        const API_URL = '/api/getData';

        const COLUMNS = {
            no: 0,
            foto: 1,       
            koordinat: 2,
            subZona: 3,
            alamat: 4,
            luas: 5,
            statusTanah: 6,
            kbli: 7,
            kelurahan: 8,
            kecamatan: 9,
            namaPemilik: 10,
            noTelp: 11,
            njop: 12
        };

        const COLUMNS_GAMBAR = {
            no: 0,
            linkGambar: 1
        };

        // Info fields configuration for display
        const infoFields = [
            { key: 'subZona', label: 'Sub Zona', icon: 'fas fa-layer-group', color: 'blue' },
            { key: 'alamat', label: 'Alamat', icon: 'fas fa-map-pin', color: 'green' },
            { key: 'kelurahan', label: 'Kelurahan', icon: 'fas fa-landmark', color: 'purple' },
            { key: 'kecamatan', label: 'Kecamatan', icon: 'fas fa-city', color: 'cyan' },
            { key: 'luas', label: 'Luas', icon: 'fas fa-ruler-combined', color: 'yellow' },
            { key: 'statusTanah', label: 'Status Tanah', icon: 'fas fa-file-contract', color: 'orange' },
            { key: 'kbli', label: 'KBLI', icon: 'fas fa-industry', color: 'indigo', isLong: true },
            { key: 'namaPemilik', label: 'Nama Pemilik', icon: 'fas fa-user', color: 'red' },
            { key: 'noTelp', label: 'No. Telepon', icon: 'fas fa-phone', color: 'teal', isPhone: true },
            { key: 'njop', label: 'NJOP', icon: 'fas fa-money-bill-wave', color: 'emerald' },
            { key: 'koordinat', label: 'Koordinat', icon: 'fas fa-crosshairs', color: 'pink' }
        ];

        let gambarMap = {}; // Map NO -> Link Gambar

        const urlParams = new URLSearchParams(window.location.search);
        const rowIndex = parseInt(urlParams.get('row')) || 0;

        async function fetchData() {
            const loadingState = document.getElementById('loading-state');
            const content = document.getElementById('content');
            const errorState = document.getElementById('error-state');

            // Show loading, hide others
            loadingState.classList.remove('hidden');
            content.classList.add('hidden');
            errorState.classList.add('hidden');

            try {
                // Fetch data dari API serverless (Spreadsheet ID tersembunyi di server)
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error('Gagal mengambil data dari server');
                }

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'Terjadi kesalahan');
                }

                const rows = result.data.table.rows;
                const rowsGambar = result.gambar.table.rows || [];

                if (rows.length === 0) {
                    throw new Error('Data tidak ditemukan di spreadsheet');
                }

                // Helper function untuk normalisasi NO (hapus spasi, convert ke string)
                const normalizeNo = (val) => {
                    if (val === null || val === undefined) return '';
                    // Convert to string dan trim
                    let str = String(val).trim();
                    // Hapus .0 jika angka (misal 99.0 -> 99)
                    if (str.match(/^\d+\.0$/)) {
                        str = str.replace('.0', '');
                    }
                    return str;
                };

                gambarMap = {};
                rowsGambar.forEach(row => {
                    const cells = row.c;
                    const no = normalizeNo(cells[COLUMNS_GAMBAR.no]?.v);
                    const linkGambar = cells[COLUMNS_GAMBAR.linkGambar]?.v ? String(cells[COLUMNS_GAMBAR.linkGambar].v).trim() : '';
                    if (no && linkGambar) {
                        gambarMap[no] = linkGambar;
                    }
                });

                console.log('Gambar Map:', gambarMap);
           
                const allData = rows.map((row, index) => {
                    const cells = row.c;
                    const no = normalizeNo(cells[COLUMNS.no]?.v);
                    
                    let foto = cells[COLUMNS.foto]?.v ? String(cells[COLUMNS.foto].v).trim() : '';
                    if (!foto && no && gambarMap[no]) {
                        foto = gambarMap[no];
                        console.log(`NO ${no}: Gambar dari Sheet2 -> ${foto}`); 
                    }

                    return {
                        index: index,
                        no: no,
                        foto: foto,
                        koordinat: cells[COLUMNS.koordinat]?.v ? String(cells[COLUMNS.koordinat].v) : '',
                        subZona: cells[COLUMNS.subZona]?.v ? String(cells[COLUMNS.subZona].v) : '-',
                        alamat: cells[COLUMNS.alamat]?.v ? String(cells[COLUMNS.alamat].v) : '-',
                        luas: cells[COLUMNS.luas]?.v ? String(cells[COLUMNS.luas].v) : '-',
                        statusTanah: cells[COLUMNS.statusTanah]?.v ? String(cells[COLUMNS.statusTanah].v) : '-',
                        kbli: cells[COLUMNS.kbli]?.v ? String(cells[COLUMNS.kbli].v) : '-',
                        kelurahan: cells[COLUMNS.kelurahan]?.v ? String(cells[COLUMNS.kelurahan].v) : '-',
                        kecamatan: cells[COLUMNS.kecamatan]?.v ? String(cells[COLUMNS.kecamatan].v) : '-',
                        namaPemilik: cells[COLUMNS.namaPemilik]?.v ? String(cells[COLUMNS.namaPemilik].v) : '-',
                        noTelp: cells[COLUMNS.noTelp]?.v ? String(cells[COLUMNS.noTelp].v) : '-',
                        njop: cells[COLUMNS.njop]?.v ? String(cells[COLUMNS.njop].v) : '-'
                    };
                });

                // Get the requested data row
                const data = allData[rowIndex];
                if (!data) {
                    throw new Error(`Data pada baris ${rowIndex + 1} tidak ditemukan`);
                }

                // Render data
                renderData(data);

                // Hide loading, show content
                loadingState.classList.add('hidden');
                content.classList.remove('hidden');

            } catch (error) {
                console.error('Error fetching data:', error);
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
                document.getElementById('error-message').textContent = error.message;
            }
        }

        function renderData(data) {
            // Header subtitle
            document.getElementById('header-subtitle').textContent = `${data.alamat}`;
            
            // Property name (use alamat or first part)
            const namaProperti = data.alamat ? String(data.alamat).split(',')[0] : 'Detail Properti';
            document.getElementById('nama-properti').textContent = namaProperti;

            // Photo from foto field (bisa dari Sheet1 atau Sheet2)
            const fotoEl = document.getElementById('foto-properti');
            const fotoFallback = document.getElementById('foto-fallback');
            const imageUrl = convertToDirectImageUrl(data.foto);
            
            if (imageUrl) {
                fotoEl.src = imageUrl;
                fotoEl.alt = `Properti #${data.no || data.index + 1}`;
                fotoEl.style.display = 'block';
                fotoFallback.style.display = 'none';
                fotoEl.onerror = function() {
                    this.onerror = null;
                    this.style.display = 'none';
                    fotoFallback.style.display = 'flex';
                };
            } else {
                fotoEl.style.display = 'none';
                fotoFallback.style.display = 'flex';
            }

            // Map and coordinates
            const koordinat = data.koordinat ? String(data.koordinat) : '';
            let lat = -6.2088, lng = 106.8456; // Default Jakarta
            
            if (koordinat && koordinat.includes(',')) {
                const parts = koordinat.split(',').map(s => parseFloat(s.trim()));
                if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                    lat = parts[0];
                    lng = parts[1];
                }
            }

            document.getElementById('peta-lokasi').src = `https://www.google.com/maps?q=${lat},${lng}&z=15&output=embed`;
            document.getElementById('koordinat-text').textContent = `${lat}, ${lng}`;
            document.getElementById('btn-maps').href = `https://www.google.com/maps?q=${lat},${lng}`;

            // Phone buttons - handle various formats
            const phoneRaw = data.noTelp ? String(data.noTelp) : '';
            const phoneNumber = phoneRaw.replace(/\D/g, '');
            if (phoneNumber) {
                document.getElementById('btn-call').href = `tel:+62${phoneNumber}`;
                document.getElementById('btn-wa').href = `https://wa.me/62${phoneNumber}`;
            }

            // Render info fields
            renderInfoFields(data);
        }

        // Convert Google Drive links to direct image URLs
        function convertToDirectImageUrl(url) {
            if (!url) return '';
            
            url = String(url).trim();
            
            // Google Drive format: https://drive.google.com/file/d/FILE_ID/view
            const driveMatch = url.match(/drive\.google\.com\/file\/d\/([^\/]+)/);
            if (driveMatch) {
                const fileId = driveMatch[1];
                // Try thumbnail URL which is more reliable
                return `https://drive.google.com/thumbnail?id=${fileId}&sz=w800`;
            }
            
            // Google Drive format: https://drive.google.com/open?id=FILE_ID
            const driveMatch2 = url.match(/drive\.google\.com\/open\?id=([^&]+)/);
            if (driveMatch2) {
                const fileId = driveMatch2[1];
                return `https://drive.google.com/thumbnail?id=${fileId}&sz=w800`;
            }

            // Google Drive direct link format: https://drive.google.com/uc?id=FILE_ID
            const driveMatch3 = url.match(/drive\.google\.com\/uc\?id=([^&]+)/);
            if (driveMatch3) {
                const fileId = driveMatch3[1];
                return `https://drive.google.com/thumbnail?id=${fileId}&sz=w800`;
            }
            
            // Already a direct URL
            if (url.startsWith('http') || url.startsWith('//')) {
                return url;
            }
            
            return '';
        }

        // Info fields rendering
        function renderInfoFields(data) {
            const container = document.getElementById('info-container');
            container.innerHTML = '';

            // Tampilkan semua fields (tidak ada yang di-skip)
            infoFields.forEach(field => {
                const value = data[field.key] || '-';
                
                const html = `
                    <div class="info-row flex items-start p-4 transition">
                        <div class="w-10 h-10 bg-${field.color}-100 rounded-full flex items-center justify-center mr-4 flex-shrink-0">
                            <i class="${field.icon} text-${field.color}-600"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-gray-500">${field.label}</p>
                            ${field.isPhone 
                                ? `<p class="font-semibold text-gray-800"><a href="tel:${value}" class="text-blue-600 hover:underline">${value}</a></p>`
                                : field.isLong 
                                    ? `<p class="font-semibold text-gray-800 text-sm leading-relaxed whitespace-pre-wrap">${value}</p>`
                                    : `<p class="font-semibold text-gray-800">${value}</p>`
                            }
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // Fetch data on page load
        fetchData();
    </script>

</body>
</html>